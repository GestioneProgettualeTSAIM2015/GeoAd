@if (ViewBag.IsAdmin)
{
    <h2>Nuovo Punto d'Interesse</h2>
}
else
{
    <h2>Nuova Attività Commerciale</h2>
}

<div class="form-horizontal" style="width:50%; float:left;">
    <hr />
    
    <input type="hidden" name="lat" id="lat" />
    <input type="hidden" name="lng" id="lng"/>

    <div class="form-group">
        <p class="control-label col-md-2">Nome</p>
        <div class="col-md-10">
             <input type="text" name="Name" class="form-control">
        </div>
    </div>

    <div class="form-group">
        <p class="control-label col-md-2">Categoria Principale</p>
        <div class="col-md-10">
            <input type="text" name="PCat" class="form-control">
        </div>
    </div>

    <div class="form-group">
        <p class="control-label col-md-2">Categoria Secondaria</p>
        <div class="col-md-10">
            <input type="text" name="SCat" class="form-control">
        </div>
    </div>

    <div class="form-group">
        <p class="control-label col-md-2">Descrizione</p>
        <div class="col-md-10">
            <input type="text" name="Desc" class="form-control">
        </div>
    </div>
    <hr />

</div>
<div id="map_container" style="height: 400px; width: 50%;">
        
</div>
<div class="form-group">
    <div class="col-md-offset-2 col-md-10">
        <button class="btn btn-default" onclick="newLocation();">Crea</button>
    </div>
</div>

<br />

<div>
    <hr />
    @Html.ActionLink("Le mie attività", "ManageLocations")
</div>

@section Scripts {
    <script type="text/javascript" src="http://maps.google.com/maps/api/js?sensor=false"></script>
    <script type="text/javascript">

        var map;
        var marker;

        function initializeMap()
        {
            var latlng = new google.maps.LatLng(45.9522249, 12.6791594);
            var options = { zoom: 16, center: latlng,
		    mapTypeId: google.maps.MapTypeId.ROADMAP};
            map = new google.maps.Map(document.getElementById("map_container"), options);

            google.maps.event.addListener(map, 'click', function (event) {
                placeMarker(event.latLng);
            });
        }

        function placeMarker(location)
        {
            document.getElementById('lat').value = location.A;
            document.getElementById('lng').value = location.F;

            if (marker != undefined)
            {
                marker.setMap(null);
            }

            marker = new google.maps.Marker({
                position: location,
                map: map
            });
        }

        $(function () {
            initializeMap();
        });

        function newLocation()
        {
            var obj = {
                "Name": $("[name='Name']").val(),
                "PCat": $("[name='PCat']").val(),
                "SCat": $("[name='SCat']").val(),
                "Lat": $("#lng").val(),
                "Lng": $("#lat").val(),
                "Desc": $("[name='Desc']").val()
            };

            $.ajax({
                url: '../api/Locations',
                type: 'POST',
                data: obj,
                beforeSend: function (xhr, settings) { xhr.setRequestHeader('Authorization', 'Bearer ' + getToken()); },
                success: function (result) {
                    window.location.replace("../");
                },
                error: function (error) {
                    alert(error.responseText);
                }
            });
        }

        function getToken() {
            return window.localStorage.getItem("token");
        }
</script>
}
